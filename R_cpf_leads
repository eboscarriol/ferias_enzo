#atualizar linha 78 com seu email , atualizar linha 48 em diante com sources
#esse arquivo atualiza os emprestimos de Leads no arquivo google sheet CPF | Issued | Invoices - Simplic, para calcular comissao dos Leads


#library(googlesheets)
library(XML)
library(httr)
library(jsonlite)
library(RPostgreSQL)
library(RPostgres)
library(googlesheets4)
library(stringr)
library(dplyr)
library(tidyverse)

drv = dbDriver("PostgreSQL")

brcon = RPostgreSQL::dbConnect(  drv
                                 , user = "simplic_nhu"
                                 , password = "Cnuacspassword123"
                                 , dbname = "staging"
                                 , host = "eis-reporting-masterdb.enova.com"
                                 , port = "5432")

qry <-"
select
funded_date::Date as data_deposito,
case when source in ('bompracredito', 'bompracreditompracredito','bompracredito_simplified_partners') then 'bompracredito'
when source in ('easycredito1', 'easycredito') then 'easycredito'
when source in ('finanzero_partner_simplified', 'finanzero_partner','finanzero') then 'finanzero'
when source in ('kwai_simplified_partners','kwai_simplified,') then 'kwai'
else source end as source,
channel,
-- case when bli.returned_or_funding_failed_flag= 1 or loan_status = 'funding_failed' then 'sim'
-- else 'nao' end as devolvido_banco,
sum(case when bli.operation_id is not null then 1 else 0 end) as emprestimo_emitido,
sum(bli.funded_amount) as valor_depositado
from nbox_simplic_sorocred.brazil_app_information bai
left join SIMPLIC_MARKETING.MKT_SIMPLIC_ADOBE_FAV_TOUCH_ATTRIBUTION_FACT a
on a.loan_application_id = bai.loan_application_id
left join simplic_analytics.brazil_loans_information bli
on bli.loan_application_id = bai.loan_application_id

left join simplic_portfolio.loan_applications la
on bai.loan_application_id = la.loan_application_id
where source in
(
  'bompracredito',
  'bompracredito_simplified_partners',
  'aff/bom-pra-credito-email',
  'aff/easycredito',
  'easycredito1',
  'easycredito_simplified',
  'ecred_simplified',
  'finanzero_partner_simplified',
  'finanzero_partner',
  'finanzero',
  'aff/idinheiro',
  'aff/iq',
  'iq_simplified',
  'jurosbaixos',
  'aff/jurosbaixos',
  'kwai_simplified_partners',
  'kwai_simplified',
  'aff/kwai',
  'querodinheiroagora_simplified',
  'aff/noverde'
)
--where source in ('aff/bom-pra-credito-email','bompracredito')
and funded_date::date >= (current_date - interval'75 day')
and bli.returned_or_funding_failed_flag!= 1
and loan_status != 'funding_failed'
and la.loan_application_status_id !=19
group by 1,2,3
order by 2 DESC"


ebs_auto <-dbGetQuery(brcon,qry)


gs4_auth(email = "eboscarriol@enova.com")

ebs_auto %>%
  write_sheet(
    ss = gs4_get(
      "https://docs.google.com/spreadsheets/d/1PaCavPeGHAtRVCjUHcQeG7dNZEk-5--QKeNwgt1T9t4/edit?gid=1508551908#gid=1508551908"),
    sheet = "issued_leads"
  )
